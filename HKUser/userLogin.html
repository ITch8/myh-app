<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>登录--用户端</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="css/common-form.css" />
		<link rel="stylesheet" href="css/login/userLogin.css" />
	</head>
	<body class="login-body">
		<div class="mui-fullscreen mui-scroll-wrapper">
			<div class="mui-scroll">
				<div class="login-pass">
					<button type="button" id="skip" class="mui-btn mui-btn-link" style="color: #32A3D6;padding-right: 0;">跳过>></button>
				</div>
				<div class="login-logo">
					<div class="login-logo-bg">
						<img src="images/logo.png" />
					</div>
				</div>
				<form id='login-form' class="mui-input-group">
					<div class="mui-input-row">
						<input id='account' type="tel" class="mui-input-clear mui-input" placeholder="请输入账号" value="">
					</div>
					<div class="mui-input-row">
						<input id='password' type="password" class="mui-input-clear mui-input" autocomplete="off" placeholder="请输入密码" value="">
					</div>
				</form>
				<div class="mui-row login-other">
					<div class="mui-pull-left">
						<button id="register" type="button" class="mui-btn mui-btn-link" style="color: #2fd080;font-size: 14px;">新用户注册</button>
					</div>
					<div class="mui-pull-right">
						<button id="forget" type="button" class="mui-btn mui-btn-link" style="color: #32A3D6;font-size: 14px;">忘记密码?</button>
					</div>
				</div>
				<div class="next">
					<button type="button" class="mui-btn mui-btn-grey" id="login">登录</button>
				</div>
				<div class="login-auth">
					------使用其他方式登录------
				</div>
				<div class="oauth-area" id="wechat"></div>
			</div>
		</div>
	</body>
	<script type="text/javascript" src="js/mui.min.js"></script>
	<script type="text/javascript" src="js/common.js" ></script>
	<script type="text/javascript">
		(function(_,doc,w,u){
			_.init({swipeBack:false,preloadPages:[
			{
				url:"my_center/contactService.html",
				id:"contactService",
				styles:{popGesture: "hide"}
			}]}),_(".mui-scroll-wrapper").scroll();
			
			var accountObj = doc.getElementById("account"),passwordObj = doc.getElementById("password");
			var myDWebView = null;
			doc.getElementById("forget").addEventListener("tap",function(){
				w.openView("forgetPwd.html");
			});
			doc.getElementById("register").addEventListener("tap",function(){
				w.openView("register.html");
			});
			//登录
			doc.getElementById("login").addEventListener("tap",function(){
				var account = accountObj.value;
				var password = passwordObj.value;
				var pdata ={
					user:account,
					pwd:password,
					userType:1
				}
				var privateToken = null;
				u.mypost("api/login",pdata,true,function(data){
					if(data.code == 0){
						_.toast(data.msg);
						privateToken = data.data.privateToken;
						w.setUser(privateToken);
						loginSkip();
//						w.openView("tabbar.html");
						setTimeout(function(){
							myDWebView = plus.webview.getWebviewById("my_center/myD.html");
							if(myDWebView){
								myDWebView.evalJS("getMyInfo()");
							}
						},100);
					}else{
						_.toast(data.msg);
					}
				},myerror);
			});
			//跳过
			doc.getElementById("skip").addEventListener("tap",function(){
				loginSkip();
			});
			//登录并隐藏登录
			function loginSkip(){
				var all = plus.webview.all();
				if(all.length > 2){
					plus.webview.hide(plus.webview.getWebviewById("userLogin"),"slide-out-right",300);
				}else{
					w.openView("tabbar.html");
				}
			}
			
			//第三方登录
			var authBtns = ['weixin','qq']; //配置业务支持的第三方登录
			var auths = {};
			var oauthArea = doc.querySelector('.oauth-area');
			_.plusReady(function(){
				//检查更新
			    if(sessionStorage.getItem('upgrade') !='1'){
	                plus.runtime.getProperty(plus.runtime.appid,function(inf){ 
	                    checkUpdate(inf.version);
	                    sessionStorage.setItem('upgrade','1');
	                });
	            }
				if(w.getUser()){
					w.openView("tabbar.html");
					setTimeout(function(){
						u.close("userLogin.html");
					},10);
				}
				setTimeout(function() {
					plus.navigator.closeSplashscreen(); //手动关闭启动页
				}, 3000);
				plus.oauth.getServices(function(services) {
					for (var i in services) {
						var service = services[i];
						auths[service.id] = service;
						if (~authBtns.indexOf(service.id)) {
							var isInstalled = app.isInstalled(service.id);
							var btn = document.createElement('div');
							//如果微信未安装，则为不启用状态
							btn.setAttribute('class', 'oauth-btn' + (!isInstalled && service.id === 'weixin' ? ('disabled') : ''));
							btn.authId = service.id;
							btn.style.backgroundImage = 'url("images/' + service.id + '.png")'
							oauthArea.appendChild(btn);
						}
					}
					_(oauthArea).on('tap', '.oauth-btn', function() {
						if (this.classList.contains('disabled')) {
							return;
						}
						var auth = auths[this.authId];
						auth.login(function() {
							plus.nativeUI.toast("登录认证成功");
							auth.getUserInfo(function() {
								plus.nativeUI.toast("获取用户信息成功");
								var name = auth.userInfo.nickname || auth.userInfo.name;
								app.createState(name, function() {
									if(auth.id == "weixin"){
										var pdata ={
											bindType:1,
											openId:auth.authResult.openid
										}
										u.mypost("api/checkBind",pdata,true,function(data){
											if(data.code == 5){
												var oid = auth.authResult.openid;
												w.openView("my_center/boundpho.html",{openId:oid,oId:auth.id});
											}else if(data.code == -1){
												_.toast(data.msg ||'');
											}else if(data.code == 0){
												data.data.privateToken?w.setUser(data.data.privateToken):_.toast("获取信息失败");
												loginSkip();
//												w.openView("tabbar.html");
											}
										},myerror);
									}else if(auth.id == "qq"){
										var pdata ={
											bindType:2,
											openId:auth.authResult.openid
										}
										u.mypost("api/checkBind",pdata,true,function(data){
											if(data.code == 5){
												var oid = auth.authResult.openid;
												w.openView("my_center/boundpho.html",{openId:oid,oId:auth.id});
											}else if(data.code == -1) {
											}else if(data.code == 0){
												data.data.privateToken?w.setUser(data.data.privateToken):_.toast("获取信息失败");
												loginSkip();
//												w.openView("tabbar.html");
											}
										},myerror);
									}else{
										loginSkip();
//										w.openView("tabbar.html");
									}
								});
							}, function(e) {
								plus.nativeUI.toast("获取用户信息失败：" + e.message);
							});
						}, function(e) {
							plus.nativeUI.toast("登录认证失败：" + e.message);
						});
					});
				}, function(e) {
					oauthArea.style.display = 'none';
					plus.nativeUI.toast("获取登录认证失败：" + e.message);
				});
				if(!w.getItem("lauchFlag")){
					w.openView("guide.html");
					return;
				}
			})
			//连续双击退出系统
			w.doubleTapExit();
			//需要传递当前的版本
		   	function checkUpdate(wgtVer){
		       	u.mypost("api/checkVersion",{clientVersion:wgtVer,pos:1},false,function(data){
		       		plus.nativeUI.closeWaiting();
			        /*返回码说明：
				     0 客户端版本号小于最新版本号 返回更新包下载url
				     1 客户端版本是最新版本 无需更新
				     2 管理员未设置最新版本号
				     3 客户端版本号小于当前版本号但管理员未上传升级包
				     -1 客户端类型传参错误或其他系统错误类型
				               附录：版本号设置和升级包上传在后台管理-系统设置。
			     	*/
			        if(parseInt(data.code) == 0){      
			            //可以升级
			            plus.nativeUI.confirm("检查到当前版本有最新更新，下载升级？",
			                function(event){
			                    if(event.index ==0){
			                        downWgt(data.data.downloadURL); //下载更新版的地址
			                    }                        
			                } ,'系统消息',['马上升级','下次再说']);                
			        } else{  
			//            	mui.toast("无新版本可更新！");
			        }
				},function(){
				    mui.toast('检测更新失败！') ;
				});
		   	}
		   	// 下载wgt文件
		   	function downWgt(wgtUrl){
//		   		var url='itms-apps://itunes.apple.com/cn/app/id1159570957';//应用在appstore的地址
		       	plus.nativeUI.showWaiting("下载更新文件...");
		       	plus.downloader.createDownload(wgtUrl,{filename:"_doc/update/"}, function(d,status){
		           	if (status == 200) {
		               	installWgt(d.filename); // 安装wgt包
		           	} else {
		               	plus.nativeUI.alert("下载更新失败！");
		           	}
		           	plus.nativeUI.closeWaiting();
		       	}).start();
		   	}
		   	// 更新应用资源  
		   	function installWgt(path){
		       	plus.nativeUI.showWaiting("安装更新文件...");
		       	plus.runtime.install(path,{},function(){
		           	plus.nativeUI.closeWaiting();        
		           	plus.nativeUI.alert("应用资源更新完成！",function(){
		               	plus.runtime.restart();
		           	});
		       	},function(e){
		           	plus.nativeUI.closeWaiting();        
		           	plus.nativeUI.alert("安装更新文件失败["+e.code+"]："+e.message);
		       	});
		   	}
		})(mui,document,window,util)
	</script>
</html>